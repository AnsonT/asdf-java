#!/usr/bin/env bash

kind=$(echo $ASDF_INSTALL_VERSION | cut -d'-' -f 1)
version=$(echo $ASDF_INSTALL_VERSION | cut -d'-' -f 2)
path=$ASDF_INSTALL_PATH

case "$(uname -s)" in
  Linux)
    os=linux
    case "$(uname -m)" in
      i[3-9]86) arch=i586 ;;
      x86_64) arch=x64 ;;
      *) echo "ERROR: Unsupported arch: '$(uname -m)'"; exit 1 ;;
    esac ;;

  Darwin)
    os=macosx
    case "$(uname -m)" in
      x86_64) arch=x64 ;;
      *) echo "ERROR: Unsupported arch: '$(uname -m)'"; exit 1 ;;
    esac ;;

  *) echo "ERROR: Unsupported OS: '$(uname -s)'"; exit 1 ;;
esac

case $kind in
  jdk)
    pack=.tar.gz

    case $version in
      9*)
        base=oracle-edge
        url=http://download.java.net/java/jdk9/archive/181/binaries/jdk-9+181_$os-$arch"_bin"$pack
        dest=jdk-9
        ;;

      8*)
        base=http://download.oracle.com/otn-pub/java

        case $version in
          # 8u144-b01/090f390dda5b47b9b721c7dfaa008135
          8u144) build=b01 check=090f390dda5b47b9b721c7dfaa008135 ;;

          # 8u141-b15/336fa29ff2bb4ef291e347e091f7f4a7
          8u141) build=b15 check=336fa29ff2bb4ef291e347e091f7f4a7 ;;

          # 8u131-b11/d54c1d3a095b4ff2b6607d096fa80163
          8u131) build=b11 check=d54c1d3a095b4ff2b6607d096fa80163 ;;

          # 8u121-b13/e9e7ea248e2c4826b92b3f075a80e441
          8u121) build=b13 check=e9e7ea248e2c4826b92b3f075a80e441 ;;

          *) echo "ERROR: Unsupported version"; exit 1 ;;
        esac

        url=$base/$kind/$version-$build/$check/$kind-$version-$os-$arch$pack
        dest=$version-$build$pack
        ;;

      7*)
        base=http://www.dropbox.com/s

        build=80

        case $os in
          linux)
            case $arch in
              i586) check=tof6j0eyqbljugy ;;
              x64) check=lni4xcu2eqhqjq9 ;;
              *) echo "ERROR: Unsupported arch"; exit 1 ;;
            esac ;;
          *) echo "ERROR: Unsupported os"; exit 1 ;;
        esac

        url=$base/$check/$kind-"$version"u$build-$os-$arch$pack
        dest=$version-$build$pack
        ;;

      *) echo "ERROR: Unsupported version"; exit 1 ;;
    esac ;;
  *) echo "ERROR: Unsupported version"; exit 1 ;;
esac

(
  echo "cd $path"
  cd $path

  case $base in
    oracle-edge)
      echo "Getting $dest"
      echo "From $url"
      curl -fLC - --retry 3 \
                  --retry-delay 3 \
                  -o $dest $url
      ;;

    *oracle*|*dropbox*)
      echo "Getting $dest"
      echo "From $url"
      curl -fLC - --retry 3 \
                  --retry-delay 3 \
                  -b oraclelicense=a \
                  -o $dest $url
      ;;

    *) echo "ERROR: Unsupported vendor"; exit 1 ;;
  esac

  case $pack in
    .tar.gz) tar -xzf $dest && rm $dest ;;
    *) echo "ERROR: Unsupported packaging"; exit 1 ;;
  esac

  name=$(ls --color=never | grep $kind)
  mv $name/* .
  rm -r $name

  asdf reshim java
)
